# ROCm-enabled override for TTS service (AMD GPU)
# Usage: docker compose -f docker-compose.yml -f docker-compose.rocm.yml up -d
#
# Prerequisites:
# 1. AMD GPU compatible with ROCm 6.0+
#    - Compatible GPUs: RX 6000/7000 series, Radeon Pro, Instinct MI series
#    - Check compatibility: https://rocm.docs.amd.com/en/latest/release/gpu_os_support.html
# 2. ROCm 6.0+ installed on host system
# 3. User added to 'render' and 'video' groups (optional, improves permissions)
#
# Installation (Ubuntu 22.04):
#   wget https://repo.radeon.com/amdgpu-install/6.0/ubuntu/jammy/amdgpu-install_6.0.60000-1_all.deb
#   sudo apt-get install ./amdgpu-install_6.0.60000-1_all.deb
#   sudo amdgpu-install -y --usecase=rocm
#   sudo usermod -a -G render,video $USER  # Optional: improve host user permissions
#
# Finding your group IDs:
#   getent group video   # Usually 44
#   getent group render  # Usually 109 or 104
#
# HSA_OVERRIDE_GFX_VERSION values:
#   - RX 6000 series (RDNA 2): 10.3.0
#   - RX 7000 series (RDNA 3): 11.0.0
#   - Check your GPU: rocminfo | grep gfx

services:
  tts-service:
    build:
      context: ./tts-service
      dockerfile: Dockerfile.rocm
      args:
        - GPU_ARCH=${GPU_ARCH:-gfx1030}
    devices:
      # KFD (Kernel Fusion Driver) for compute operations
      - /dev/kfd
      # DRI (Direct Rendering Infrastructure) for graphics
      - /dev/dri
    group_add:
      # Required group IDs for ROCm device access
      # Use numeric GIDs instead of names for compatibility
      # Find yours with: getent group video && getent group render
      - "44"   # video group (standard GID)
      - "992"  # render group (check your system's GID with getent group render)
    environment:
      # Specify which GPU to use (0 for first GPU, 1 for second, etc.)
      - ROCM_VISIBLE_DEVICES=0
      # Override GFX version if needed (set according to your GPU model)
      # Uncomment and modify for your specific GPU:
      # - HSA_OVERRIDE_GFX_VERSION=10.3.0
      # ROCm runtime will use CUDA API compatibility layer
      - HSA_ENABLE_SDMA=0
